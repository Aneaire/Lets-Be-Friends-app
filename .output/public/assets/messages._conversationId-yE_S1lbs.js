import{c as C,k as S,u as A,a as h,r as l,d as w,j as e,L as U}from"./index-5PltJSx_.js";import{a as u}from"./api-Df4qyv35.js";import{w as _}from"./auth-BhrcrAHN.js";import{A as L}from"./arrow-left-C7m3PQ5f.js";import{E}from"./ellipsis-vertical-D_ARX9Ke.js";import{S as D}from"./send-9tvlxndf.js";const P=[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]],$=C("paperclip",P);function B(){const{conversationId:r}=S.useParams(),{userId:i}=A(),n=h(u.users.getCurrentUser,{clerkId:i??""}),s=h(u.messages.getConversation,{conversationId:r}),t=h(u.messages.getMessagesForConversation,{conversationId:r}),[a,f]=l.useState(""),[c,x]=l.useState([]),p=l.useRef(null),j=l.useRef(null),I=w(u.messages.sendMessage),v=w(u.messages.markMessagesAsRead),y=s?.participants.find(o=>o!==n?._id);l.useEffect(()=>{p.current&&(p.current.scrollTop=p.current.scrollHeight)},[t?.length]),l.useEffect(()=>{n&&s&&v({conversationId:s._id,userId:n._id})},[s,n,v]);const N=()=>{!a.trim()&&c.length===0||!n||!s||(I({conversationId:s._id,senderId:n._id,content:a||void 0,images:c}),f(""),x([]))},k=o=>{const d=o.target.files;if(!d)return;const g=[];for(let m=0;m<d.length;m++){const b=d[m];if(b.type.startsWith("image/")){const R=URL.createObjectURL(b);g.push(R)}}x([...c,...g])},M=o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),N())};return e.jsx("div",{className:"container mx-auto px-4 py-8 h-[calc(100vh-2rem)]",children:e.jsxs("div",{className:"max-w-4xl mx-auto h-full flex flex-col",children:[e.jsxs("div",{className:"mb-4 border-b pb-4 flex items-center gap-4",children:[e.jsx(U,{to:"/messages",className:"p-2 hover:bg-muted rounded-md",children:e.jsx(L,{className:"h-5 w-5"})}),e.jsx("div",{className:"flex-1",children:e.jsx("h2",{className:"text-xl font-semibold",children:y?`User ${y.substring(0,8)}`:"Unknown"})}),e.jsx("button",{className:"p-2 hover:bg-muted rounded-md",children:e.jsx(E,{className:"h-5 w-5 text-muted-foreground"})})]}),e.jsx("div",{ref:p,className:"flex-1 overflow-y-auto space-y-4 mb-4 pr-2",children:!s||!t?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Loading conversation..."}):t&&t.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No messages yet. Say hello!"}):e.jsx(K,{messages:t,currentUserId:n?._id??""})}),e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[c.length>0&&e.jsx("div",{className:"flex gap-2 flex-wrap",children:c.map((o,d)=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:o,alt:"Upload preview",className:"h-16 w-16 object-cover rounded-md"}),e.jsx("button",{onClick:()=>x(c.filter((g,m)=>m!==d)),className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity",children:"Ã—"})]},d))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"file",ref:j,className:"hidden",accept:"image/*",multiple:!0,onChange:k}),e.jsx("button",{onClick:()=>j.current?.click(),className:"p-2 hover:bg-muted rounded-md",title:"Attach images",children:e.jsx($,{className:"h-5 w-5 text-muted-foreground"})}),e.jsx("input",{type:"text",value:a,onChange:o=>f(o.target.value),onKeyPress:M,placeholder:"Type a message...",className:"flex-1 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary"}),e.jsxs("button",{onClick:N,disabled:!a.trim()&&c.length===0,className:"bg-primary text-primary-foreground px-4 py-2 rounded-md font-medium hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:[e.jsx(D,{className:"h-4 w-4"}),"Send"]})]})]})]})})}function K({messages:r,currentUserId:i}){const n=r.reduce((s,t)=>{const a=new Date(t.createdAt).toDateString();return s[a]||(s[a]=[]),s[a].push(t),s},{});return e.jsx(e.Fragment,{children:Object.entries(n).map(([s,t])=>e.jsxs("div",{children:[e.jsx("div",{className:"text-center mb-4",children:e.jsx("span",{className:"bg-muted px-3 py-1 rounded-full text-xs text-muted-foreground",children:new Date(s).toLocaleDateString([],{weekday:"long",month:"short",day:"numeric"})})}),e.jsx("div",{className:"space-y-3",children:t.map(a=>e.jsx(T,{message:a,isOwn:a.senderId===i},a._id))})]},s))})}function T({message:r,isOwn:i}){const n=!i&&r.readBy.length>0;return e.jsx("div",{className:`flex ${i?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] rounded-lg p-3 ${i?"bg-primary text-primary-foreground":"bg-muted text-foreground"}`,children:[r.images.length>0&&e.jsx("div",{className:"grid grid-cols-2 gap-1 mb-2",children:r.images.map((s,t)=>e.jsx("img",{src:s,alt:"Message image",className:"rounded-md max-w-full"},t))}),r.content&&e.jsx("p",{className:"whitespace-pre-wrap break-words",children:r.content}),e.jsxs("div",{className:`flex items-center gap-1 mt-1 text-xs ${i?"text-primary-foreground/70":"text-muted-foreground"}`,children:[new Date(r.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),i&&n&&e.jsx("span",{children:"Read"})]})]})})}const z=_(B);export{z as component};
